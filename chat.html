<!DOCTYPE html>
<html>
<head>
    <title>BATC Chat Overlay</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="widget-window chat-window-size">
        <div class="widget-header">
            <span id="header-text">Connecting...</span>
            <span id="viewer-count">0 viewers</span>
        </div>
        <div id="chat-container"></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        // Enter the room name exactly as the server requires it
        var DEFAULT_ROOM = "M0ODZ"; 

        // Get room from URL parameter (e.g. chat.html?room=M0ODZ) or use default
        var urlParams = new URLSearchParams(window.location.search);
        var ROOM_NAME = urlParams.get('room') || DEFAULT_ROOM; 

        var socket = io('https://batc.org.uk', {
            path: "/live-chat/socket.io",
            query: 'room=' + ROOM_NAME
        });

        socket.on('connect', function() {
            $('#header-text').text("Chatlog: " + ROOM_NAME);
        });

        socket.on('viewers', function(data) {
            if (data && data.num !== undefined) {
                $('#viewer-count').text(data.num + " viewers");
            }
        });

        socket.on('history', function(data) {
            if (data && data.history && data.history.length > 0) {
                $('#chat-container').empty(); 
                data.history.forEach(function(msg) {
                    appendMsg(msg.name, msg.message);
                });
            }
        });

        socket.on('message', function(data) {
            appendMsg(data.name, data.message);
        });

        function appendMsg(name, text) {
            var $msg = $('<div class="message"></div>');
            $msg.append($('<span class="nick"></span>').text(name));
            $msg.append($('<span class="text"></span>').text(text));
            $('#chat-container').append($msg);
            var container = $('#chat-container');
            container.scrollTop(container[0].scrollHeight);
            if ($('.message').length > 50) { $('.message').first().remove(); }
        }
    </script>
</body>
</html>
