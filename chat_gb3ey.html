<!DOCTYPE html>
<html>
<head>
    <title>BATC Chat Overlay</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="widget-window chat-window-size">
        <div class="widget-header">
            <span id="widget-title">Detecting Room...</span>
            <span id="viewer-count">0 viewers</span>
        </div>
        <div id="chat-container"></div>
    </div>

    <script>
        var filename = window.location.pathname.split('/').pop();
        var ROOM_NAME = filename.split('_')[1].split('.')[0]; 

        var socket = io('https://batc.org.uk', {
            path: "/live-chat/socket.io",
            query: 'room=' + ROOM_NAME
        });

        socket.on('connect', function() {
            $('#widget-title').text("Chatlog: " + ROOM_NAME);
        });

        socket.on('viewers', function(data) {
            if (data && data.num !== undefined) $('#viewer-count').text(data.num + " viewers");
        });

        socket.on('history', function(data) {
            if (data && data.history && data.history.length > 0) {
                $('#chat-container').empty(); 
                data.history.forEach(function(msg) {
                    appendMsg(msg.name, msg.message);
                });
            }
        });

        socket.on('message', function(data) {
            appendMsg(data.name, data.message);
        });

        function appendMsg(name, text) {
            var $msg = $('<div class="message"></div>');
            $msg.append($('<span class="nick"></span>').text(name + ": "));
            $msg.append($('<span class="text"></span>').text(text));
            $('#chat-container').append($msg);
            if ($('.message').length > 50) { $('.message').first().remove(); }
        }
    </script>
</body>
</html>
